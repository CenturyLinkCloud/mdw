<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:osgi="http://www.springframework.org/schema/osgi"
  xmlns:osgix="http://www.springframework.org/schema/osgi-compendium"
  xmlns:ctx="http://www.springframework.org/schema/context"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
                      http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi.xsd
                      http://www.springframework.org/schema/osgi-compendium http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd
                      http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd">


  <osgix:cm-properties id="mdwProps" persistent-id="com.centurylink.mdw" />

  <ctx:property-placeholder properties-ref="mdwProps" />  

  <bean id="exporter" class="org.springframework.jmx.export.MBeanExporter" lazy-init="false">
    <property name="beans">
      <map>
        <entry key="com.centurylink.mdw:name=mdwDataSource" value-ref="mdwDataSource"/>
      </map>
    </property>
    <property name="registrationBehaviorName" value="REGISTRATION_REPLACE_EXISTING"/>
  </bean>
  
  <bean id="mdwDataSource"
    class="org.apache.commons.dbcp.BasicDataSource"
    destroy-method="close">
    <property name="driverClassName" value="${mdw.database.driver}" />
    <property name="url" value="${mdw.database.url}" />
    <property name="username" value="${mdw.database.username}" />
    <property name="password" value="${mdw.database.password}" />
    <property name="maxActive" value="${mdw.database.poolsize}" />
    <property name="maxIdle" value="${mdw.database.poolMaxIdle}"/>
    <property name="validationQuery" value="SELECT 1 FROM DUAL" />
    <property name="testOnBorrow" value="true" />
    <property name="testWhileIdle" value="true" />
    <property name="removeAbandoned" value="true"/>
    <!-- logAbandoned messages go to STDOUT, which unfortunately is not captured in our Linux VM ServiceMix setup -->
    <property name="logAbandoned" value="true"/>
    <property name="removeAbandonedTimeout" value="600"/>
    <property name="connectionProperties" value="${mdw.database.connectionProperties:defaultRowPrefetch=200}" />
  </bean>
  
  <osgi:service id="mdwOsgiDataSource" ref="mdwDataSource">
    <osgi:interfaces>
      <value>javax.sql.DataSource</value>
    </osgi:interfaces>
    <osgi:service-properties>
      <entry key="name" value="MDWDataSource"/>
    </osgi:service-properties>
  </osgi:service>
  
  <bean id="jmsProvider" class="com.centurylink.mdw.container.plugins.activemq.ActiveMqJms" />
  <osgi:service id="mdwJmsProvider" ref="jmsProvider">
    <osgi:interfaces>
      <value>com.centurylink.mdw.container.JmsProvider</value>
    </osgi:interfaces>
  </osgi:service>
  
  <bean id="configurationServiceFactory"
    class="com.centurylink.mdw.common.config.service.ConfigurationServiceFactory" />
    
  <bean id="configurationService" 
    factory-bean="configurationServiceFactory"
    factory-method="getConfigurationService">
    <osgix:managed-properties persistent-id="com.centurylink.mdw" 
      update-strategy="bean-managed" update-method="updateProperties"/>    
  </bean>
  
  <osgi:service ref="configurationService">
    <osgi:interfaces>
      <value>com.centurylink.mdw.common.config.service.ConfigurationService</value>
    </osgi:interfaces>
  </osgi:service>
  
  <!-- 
  <bean id="mdwBundleConfigurer"
      class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
    <property name="ignoreUnresolvablePlaceholders" value="true"/>
    <property name="propertiesArray">
      <array>
        <osgix:cm-properties id="mdwProperties" persistent-id="com.centurylink.mdw"/>
        <osgix:cm-properties id="myBundleProps" persistent-id="application.properties"/>
      </array>
    </property>
  </bean>  
 
  <osgi:reference id="configAdmin"
    interface="org.osgi.service.cm.ConfigurationAdmin" />
    <bean id="processor" 
      class="com.centurylink.mdw.osgi.config.BundleConfigurationManager">
      <property name="configAdmin" ref="configAdmin" />
    </bean>
   -->

  <!-- test services -->
  <bean id="testUserService"
    class="com.centurylink.mdw.test.impl.TestUserServiceBean" />
  <osgi:service ref="testUserService">
    <osgi:interfaces>
      <value>com.centurylink.mdw.test.TestUserService</value>
    </osgi:interfaces>
  </osgi:service>

</beans>
